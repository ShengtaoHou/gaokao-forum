var AddArticle={editor:void 0,rewardEditor:void 0,remove:function(e,t){confirm(Label.confirmRemoveLabel)&&$.ajax({url:Label.servePath+"/article/"+Label.articleOId+"/remove",type:"POST",headers:{csrfToken:e},cache:!1,beforeSend:function(){$(t).attr("disabled","disabled").css("opacity","0.3")},error:function(e,t,a){$("#addArticleTip").addClass("error").html("<ul><li>"+a+"</li></ul>")},success:function(e,a){$(t).removeAttr("disabled").css("opacity","1"),0===e.sc?window.location.href=Label.servePath+"/member/"+Label.userName:$("#addArticleTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},complete:function(){$(t).removeAttr("disabled").css("opacity","1")}})},add:function(e,t){if(Validate.goValidate({target:$("#addArticleTip"),data:[{type:"string",max:256,msg:Label.articleTitleErrorLabel,target:$("#articleTitle")},{type:"editor",target:this.editor,max:1048576,min:4,msg:Label.articleContentErrorLabel}]})){if($("#articleRewardPoint").data("orval")&&!/^\+?[1-9][0-9]*$/.test($("#articleRewardPoint").val()))return $("#addArticleTip").addClass("error").html("<ul><li>"+Label.articleRewardPointErrorLabel+"</li></ul>"),!1;var a="";$(".tags-input .tag .text").each(function(){a+=$(this).text()+","});var i={articleTitle:$("#articleTitle").val().replace(/(^\s*)|(\s*$)/g,""),articleContent:this.editor.getValue(),articleTags:a,articleCommentable:!0,articleType:$("input[type='radio'][name='articleType']:checked").val(),articleRewardContent:this.rewardEditor.getValue(),articleRewardPoint:$("#articleRewardPoint").val().replace(/(^\s*)|(\s*$)/g,""),articleAnonymous:$("#articleAnonymous").prop("checked"),syncWithSymphonyClient:$("#syncWithSymphonyClient").prop("checked")},r=Label.servePath+"/article",l="POST";3===parseInt(i.articleType)&&(i.articleContent=JSON.parse(window.localStorage.postData).thoughtContent),Label.articleOId&&(r=r+"/"+Label.articleOId,l="PUT"),$.ajax({url:r,type:l,headers:{csrfToken:e},cache:!1,data:JSON.stringify(i),beforeSend:function(){$(t).attr("disabled","disabled").css("opacity","0.3")},error:function(e,t,a){$("#addArticleTip").addClass("error").html("<ul><li>"+a+"</li></ul>")},success:function(e,a){$(t).removeAttr("disabled").css("opacity","1"),0===e.sc?(window.location.href=Label.servePath+"/article/"+e.articleId,localStorage.removeItem("postData")):$("#addArticleTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},complete:function(){$(t).removeAttr("disabled").css("opacity","1")}})}},init:function(){$.ua.set(navigator.userAgent),location.search.indexOf("?id=")>-1&&localStorage.removeItem("postData");var e=void 0;if(localStorage.postData?e=JSON.parse(localStorage.postData):(e={title:"",content:"",tags:"",thoughtContent:"",rewardContent:"",rewardPoint:""},localStorage.postData=JSON.stringify(e)),""!==e.content&&$("#articleContent").val(e.content),"mobile"!==$.ua.device.type||"Apple"!==$.ua.device.vendor&&"Nokia"!==$.ua.device.vendor){Util.initCodeMirror();var t=new Editor({element:document.getElementById("articleContent"),dragDrop:!1,lineWrapping:!0,htmlURL:Label.servePath+"/markdown",readOnly:Label.requisite,extraKeys:{"Alt-/":"autocompleteUserName","Ctrl-/":"autocompleteEmoji","Cmd-/":"autocompleteEmoji","Alt-S":"startAudioRecord","Alt-R":"endAudioRecord"},toolbar:[{name:"emoji"},{name:"bold"},{name:"italic"},{name:"quote"},{name:"link"},{name:"image",html:'<div class="tooltipped tooltipped-n" aria-label="'+Label.uploadFileLabel+'" ><form id="fileUpload" method="POST" enctype="multipart/form-data"><label class="icon-upload"><svg><use xlink:href="#upload"></use></svg><input type="file"/></label></form></div>'},{name:"unordered-list"},{name:"ordered-list"},{name:"view"},{name:"fullscreen"},{name:"question",action:"https://hacpai.com/guide/markdown"}],status:!1});t.render(),AddArticle.editor=t.codemirror}else AddArticle.editor=Util.initTextarea("articleContent",function(e){var t=JSON.parse(localStorage.postData);t.content=e.getValue(),localStorage.postData=JSON.stringify(t)}),$("#articleContent").before('<form id="fileUpload" method="POST" enctype="multipart/form-data"><label class="btn">'+Label.uploadLabel+'<input type="file"/></label></form>').css("margin-top",0);if($(".post-article-content .editor-toolbar .icon-view:eq(0)").parent().click(),-1!==location.href.indexOf("at=")){if(""==e.content){var a=AddArticle.editor.getValue();AddArticle.editor.setValue("\n\n\n"+a),AddArticle.editor.setCursor(CodeMirror.Pos(0,0)),AddArticle.editor.focus()}if(""==e.title){var i=Util.getParameterByName("at");$("#articleTitle").val("Hi, "+i)}if(""!==e.tags){var r=Label.discussionLabel,l=Util.getParameterByName("tags");""!==l&&(r+=","+l),$("#articleTags").val(r)}}if(""==e.title){var o=Util.getParameterByName("title");o&&o.length>0&&$("#articleTitle").val(o)}if(""!==e.title&&$("#articleTitle").val(e.title),$("#articleTitle").keyup(function(){var e=JSON.parse(localStorage.postData);e.title=$(this).val(),localStorage.postData=JSON.stringify(e)}),""!==e.tags&&$("#articleTags").val(e.tags),this._initTag(),"mobile"!==$.ua.device.type||"Apple"!==$.ua.device.vendor&&"Nokia"!==$.ua.device.vendor){AddArticle.editor.on("keydown",function(e,t){if(8===t.keyCode){var a=e.getCursor(),i=e.getTokenAt(a),r=CodeMirror.Pos(a.line,a.ch);i=e.getTokenAt(r),/^:\S+:$/.test(i.string)&&e.replaceRange("",CodeMirror.Pos(a.line,i.start),CodeMirror.Pos(a.line,i.end-1))}});var n="";AddArticle.editor.on("changes",function(e,t){var a=JSON.parse(localStorage.postData);a.content=e.getValue(),""===n&&(n=(new Date).getTime());var i=e.getCursor();if(0===e.getTokenAt(i).string.indexOf("@"))return e.showHint({hint:CodeMirror.hint.userName,completeSingle:!1}),CodeMirror.Pass;var r="",l=String.fromCharCode(31),o=(new Date).getTime()-n;switch(t[0].origin){case"+delete":r=String.fromCharCode(24)+l+o+l+t[0].from.ch+"-"+t[0].from.line+l+t[0].to.ch+"-"+t[0].to.line+String.fromCharCode(30);break;case"*compose":case"+input":default:for(var s=0;s<t[0].text.length;s++)s===t[0].text.length-1?r+=t[0].text[s]:r+=t[0].text[s]+String.fromCharCode(10);for(var c=0;c<t[0].removed.length;c++)if(0===c){r+=String.fromCharCode(29);break}r+=l+o+l+t[0].from.ch+"-"+t[0].from.line+l+t[0].to.ch+"-"+t[0].to.line+String.fromCharCode(30)}if(a.thoughtContent+=r,localStorage.postData=JSON.stringify(a),0===$(".post-article-content .editor-preview-active").length)return!1;$.ajax({url:Label.servePath+"/markdown",type:"POST",cache:!1,data:{markdownText:e.getValue()},success:function(e,t){$(".post-article-content .editor-preview-active").html(e.html),hljs.initHighlighting.called=!1,hljs.initHighlighting()}})})}if($("#articleTitle").val().length<=0&&$("#articleTitle").focus(),$("#articleTitle").blur(function(){if(""===$.trim($(this).val()))return!1;1!==Label.articleType&&$.ajax({url:Label.servePath+"/article/check-title",type:"POST",data:JSON.stringify({articleTitle:$.trim($(this).val()),articleId:Label.articleOId}),success:function(e,t){e.sc?$("#articleTitleTip").remove():1===$("#articleTitleTip").length?$("#articleTitleTip").html(e.msg):$("#articleTitle").after('<div class="module" id="articleTitleTip">'+e.msg+"</div>")}})}),$("#articleTags, #articleRewardPoint").keypress(function(e){if(e.ctrlKey&&10===e.charCode)return AddArticle.add(),!1}),0<$("#articleRewardPoint").val().replace(/(^\s*)|(\s*$)/g,"")&&$("#showReward").click(),"mobile"!==$.ua.device.type||"Apple"!==$.ua.device.vendor&&"Nokia"!==$.ua.device.vendor){var s=new Editor({element:document.getElementById("articleRewardContent"),dragDrop:!1,lineWrapping:!0,htmlURL:Label.servePath+"/markdown",toolbar:[{name:"emoji"},{name:"bold"},{name:"italic"},{name:"quote"},{name:"link"},{name:"image",html:'<div class="tooltipped tooltipped-n" aria-label="'+Label.uploadFileLabel+'" ><form id="rewardFileUpload" method="POST" enctype="multipart/form-data"><label class="icon-upload"><svg><use xlink:href="#upload"></use></svg><input type="file"/></label></form></div>'},{name:"unordered-list"},{name:"ordered-list"},{name:"view"},{name:"fullscreen"},{name:"question",action:"https://hacpai.com/guide/markdown"}],extraKeys:{"Alt-/":"autocompleteUserName","Ctrl-/":"autocompleteEmoji","Cmd-/":"autocompleteEmoji","Alt-S":"startAudioRecord","Alt-R":"endAudioRecord"},status:!1});s.render(),AddArticle.rewardEditor=s.codemirror,AddArticle.rewardEditor.on("keydown",function(e,t){if(8===t.keyCode){var a=e.getCursor(),i=e.getTokenAt(a),r=CodeMirror.Pos(a.line,a.ch);i=e.getTokenAt(r),/^:\S+:$/.test(i.string)&&e.replaceRange("",CodeMirror.Pos(a.line,i.start),CodeMirror.Pos(a.line,i.end-1))}}),AddArticle.rewardEditor.on("changes",function(e){var t=e.getCursor();if(0===e.getTokenAt(t).string.indexOf("@"))return e.showHint({hint:CodeMirror.hint.userName,completeSingle:!1}),CodeMirror.Pass;var a=JSON.parse(localStorage.postData);if(a.rewardContent=e.getValue(),localStorage.postData=JSON.stringify(a),0===$(".article-reward-content .editor-preview-active").length)return!1;$.ajax({url:Label.servePath+"/markdown",type:"POST",cache:!1,data:{markdownText:e.getValue()},success:function(e,t){$(".article-reward-content .editor-preview-active").html(e.html),hljs.initHighlighting.called=!1,hljs.initHighlighting()}})})}else AddArticle.rewardEditor=Util.initTextarea("articleRewardContent",function(e){var t=JSON.parse(localStorage.postData);t.rewardContent=e.getValue(),localStorage.postData=JSON.stringify(t)}),$("#articleRewardContent").before('<form id="rewardFileUpload" method="POST" enctype="multipart/form-data"><label class="btn">'+Label.uploadLabel+'<input type="file"/></label></form>').css("margin-top",0);$("#articleContent").next().next().height(330),""!==e.rewardContent&&($("#showReward").click(),AddArticle.rewardEditor.setValue(e.rewardContent)),""!==e.rewardPoint&&($("#showReward").click(),$("#articleRewardPoint").val(e.rewardPoint)),$("#articleRewardPoint").keyup(function(){var e=JSON.parse(localStorage.postData);e.rewardPoint=$(this).val(),localStorage.postData=JSON.stringify(e)})},_initTag:function(){$.ua.set(navigator.userAgent);var e=function(e){if(""===e.replace(/\s/g,""))return!1;var t=!1;if(e=e.replace(/\s/g,"").replace(/,/g,""),$("#articleTags").val(""),$(".tags-input .text").each(function(){var a=$(this);e===a.text()&&(a.parent().addClass("haved"),setTimeout(function(){a.parent().removeClass("haved")},900),t=!0)}),t)return!1;if($(".tags-input .tag").length>=4)return $("#articleTags").val("").data("val",""),!1;if($(".post .tags-selected").append('<span class="tag"><span class="text">'+e+'</span><span class="close">x</span></span>'),$("#articleTags").width($(".tags-input").width()-$(".post .tags-selected").width()-10),-1===location.search.indexOf("?id=")){var a="";$(".tags-input .tag .text").each(function(){a+=$(this).text()+","});var i=JSON.parse(localStorage.postData);i.tags=a,localStorage.postData=JSON.stringify(i)}$(".tags-input .tag").length>=4&&$("#articleTags").val("").data("val","")};$(".domains-tags .btn").click(function(){$(".domains-tags .btn.current").removeClass("current green"),$(this).addClass("current").addClass("green"),$(".domains-tags .domain-tags").hide(),$("#tags"+$(this).data("id")).show()});for(var t=$("#articleTags").val().split(","),a=0,i=t.length;a<i;a++)e(t[a]);$(".domain-tags .tag").click(function(){e($(this).text())}),$(".tags-input").on("click",".tag > span.close",function(){if($(this).parent().remove(),$("#articleTags").width($(".tags-input").width()-$(".post .tags-selected").width()-10),-1===location.search.indexOf("?id=")){var e="";$(".tags-input .tag .text").each(function(){e+=$(this).text()+","});var t=JSON.parse(localStorage.postData);t.tags=e,localStorage.postData=JSON.stringify(t)}}),$("#articleTags").click(function(){$(".post .domains-tags").show(),"mobile"!==$.ua.device.type&&$(".post .domains-tags").css("left",$(".post .tags-selected").width()+10+"px"),$("#articleTagsSelectedPanel").hide()}).blur(function(){if("block"===$("#articleTagsSelectedPanel").css("display"))return!1;e($(this).val())}),$("body").click(function(e){1===$(e.target).closest(".tags-input").length||1===$(e.target).closest(".domains-tags").length||$(".post .domains-tags").hide()}),$("#articleTags").completed({height:170,onlySelect:!0,data:[],afterSelected:function(t){e(t.text())},afterKeyup:function(t){if($(".post .domains-tags").hide(),","===t.key||"，"===t.key||"、"===t.key||"；"===t.key||";"===t.key){var a=$("#articleTags").val();return e(a.substr(0,a.length-1)),!1}return 13===t.keyCode?(e($("#articleTags").val()),!1):37!==t.keyCode&&39!==t.keyCode&&38!==t.keyCode&&40!==t.keyCode&&(27===t.keyCode?($("#articleTagsSelectedPanel").hide(),!1):8===t.keyCode&&8===t.data.settings.chinese&&""===t.data.settings.keydownVal.replace(/\s/g,"")?($(".tags-input .tag .close:last").click(),!1):""!==$("#articleTags").val().replace(/\s/g,"")&&void $.ajax({url:Label.servePath+"/tags/query?title="+$("#articleTags").val(),error:function(e,t,a){$("#addArticleTip").addClass("error").html("<ul><li>"+a+"</li></ul>")},success:function(e,t){e.sc?("mobile"!==$.ua.device.type&&$("#articleTagsSelectedPanel").css("left",$(".post .tags-selected").width()+10+"px"),$("#articleTags").completed("updateData",e.tags)):console.log(e)}}))}})}};AddArticle.init();