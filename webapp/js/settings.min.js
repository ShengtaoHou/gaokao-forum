var Settings={homeScroll:function(){$(".nav-tabs").html($(".home-menu").html()),$(".nav").css({position:"fixed","box-shadow":"0 1px 2px rgba(0,0,0,.2)"}),$(".main").css("paddingTop","68px")},notiScroll:function(){var e=$("#side"),a=e.width(),t=1===$(".small-tips").closest(".module").length?109+$(".small-tips").closest(".module").height():89;$(".side.fn-none").height(e.height()),$(window).scroll(function(){$(window).scrollTop()>t?(e.css({position:"fixed",width:a+"px",top:0,right:$(".wrapper").css("margin-right")}),$(".side.fn-none").show(),$(".small-tips").closest(".module").hide()):(e.removeAttr("style"),$(".side.fn-none").hide(),$(".small-tips").closest(".module").show())})},initHljs:function(){if(0===$("pre code").length)return!1;$.ajax({method:"GET",url:Label.servePath+"/js/lib/highlight.js-9.6.0/highlight.pack.js",dataType:"script"}).done(function(){$("pre code").each(function(e,a){hljs.highlightBlock(a),$(this).css("max-height",$(window).height()-68)})})},preview:function(e){"block"===$("#homeSidePanel").css("display")?($("#homeSidePanel").hide(),$(e).text(Label.previewLabel)):($("#homeSidePanel").show(),$("#userNicknameDom").text($("#userNickname").val()),$("#userTagsDom").text($("#userTags").val()),$("#userURLDom").text($("#userURL").val()).attr("href",$("#userURL").val()),$("#userIntroDom").text($("#userIntro").val()),$(e).text(Label.unPreviewLabel))},initUploadAvatar:function(e,a,t){var r="";""===e.qiniuUploadToken?$("#"+e.id).fileupload({acceptFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,maxFileSize:parseInt(e.maxSize),multipart:!0,pasteZone:null,dropZone:null,url:Label.servePath+"/upload",add:function(e,a){if(r=a.files[0].type.split("/")[1],window.File&&window.FileReader&&window.FileList&&window.Blob){var t=new FileReader;t.readAsArrayBuffer(a.files[0]),t.onload=function(e){var t=new Uint8Array(e.target.result.slice(0,11));return isImage(t)?e.target.result.byteLength>1048576?void alert("This image is too large (max 1M)"):void a.submit():void alert("Image only~")}}else a.submit()},formData:function(e){return e.serializeArray()},submit:function(e,a){},done:function(e,t){if(!t.result.key)return void alert("Upload error");a(t)},fail:function(e,a){alert("Upload error: "+a.errorThrown)}}).on("fileuploadprocessalways",function(e,a){var t=a.files[a.index];a.files.error&&t.error&&alert(t.error)}):$("#"+e.id).fileupload({acceptFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,maxFileSize:parseInt(e.maxSize),multipart:!0,pasteZone:null,dropZone:null,url:"https://up.qbox.me/",add:function(e,a){if(r=a.files[0].type.split("/")[1],window.File&&window.FileReader&&window.FileList&&window.Blob){var t=new FileReader;t.readAsArrayBuffer(a.files[0]),t.onload=function(e){var t=new Uint8Array(e.target.result.slice(0,11));return isImage(t)?e.target.result.byteLength>1048576?void alert("This image is too large (max 1M)"):void a.submit():void alert("Image only~")}}else a.submit()},formData:function(a){var t=a.serializeArray();return t.push({name:"token",value:e.qiniuUploadToken}),t.push({name:"key",value:"avatar/"+e.userId+"_"+(new Date).getTime()+"."+r}),console.log(t),t},submit:function(e,a){},done:function(e,a){if(!a.result.key)return void alert("Upload error");t(a)},fail:function(e,a){alert("Upload error: "+a.errorThrown)}}).on("fileuploadprocessalways",function(e,a){var t=a.files[a.index];a.files.error&&t.error&&alert(t.error)})},exportPosts:function(){$.ajax({url:Label.servePath+"/export/posts",type:"POST",cache:!1,success:function(e,a){if(!e.sc)return void alert("TBD: V, tip display it....");window.open(e.url)}})},changeGeoStatus:function(e){var a={userGeoStatus:$("#geoStatus").val()};$.ajax({url:Label.servePath+"/settings/geo/status",type:"POST",headers:{csrfToken:e},cache:!1,data:JSON.stringify(a),success:function(e,a){console.log(e)}})},pointTransfer:function(e){if(Validate.goValidate({target:$("#pointTransferTip"),data:[{target:$("#pointTransferUserName"),type:"string",max:256,msg:Label.invalidUserNameLabel},{target:$("#pointTransferAmount"),type:"string",max:50,msg:Label.amountNotEmpty}]})){var a={userName:$("#pointTransferUserName").val(),amount:$("#pointTransferAmount").val()};$.ajax({url:Label.servePath+"/point/transfer",type:"POST",headers:{csrfToken:e},cache:!1,data:JSON.stringify(a),beforeSend:function(){$("#pointTransferTip").removeClass("succ").removeClass("error").html("")},error:function(e,a,t){alert(t)},success:function(e,a){e.sc?($("#pointTransferTip").addClass("succ").removeClass("error").html("<ul><li>"+Label.transferSuccLabel+"</li></ul>"),$("#pointTransferUserName").val(""),$("#pointTransferAmount").val("")):$("#pointTransferTip").addClass("error").removeClass("succ").html("<ul><li>"+e.msg+"</li></ul>"),$("#pointTransferTip").show(),setTimeout(function(){$("#pointTransferTip").hide()},2e3)}})}},pointBuyInvitecode:function(e){var a={};$.ajax({url:Label.servePath+"/point/buy-invitecode",type:"POST",headers:{csrfToken:e},cache:!1,data:JSON.stringify(a),beforeSend:function(){$("#pointBuyInvitecodeTip").removeClass("succ").removeClass("error").html("")},error:function(e,a,t){alert(t)},success:function(e,a){e.sc?$(".list ul").prepend('<li class="content-reset"><code>'+e.msg.split(" ")[0]+"</code>"+e.msg.substr(16)+"</li>"):$("#pointBuyInvitecodeTip").addClass("error").removeClass("succ").html("<ul><li>"+e.msg+"</li></ul>"),$("#pointBuyInvitecodeTip").show()}})},queryInvitecode:function(e){var a={invitecode:$("#invitecode").val()};$.ajax({url:Label.servePath+"/invitecode/state",type:"POST",headers:{csrfToken:e},cache:!1,data:JSON.stringify(a),beforeSend:function(){$("#invitecodeStateTip").removeClass("succ").removeClass("error").html("")},error:function(e,a,t){alert(t)},success:function(e,a){switch(e.sc){case-1:case 0:case 2:$("#invitecodeStateTip").addClass("error").removeClass("succ").html("<ul><li>"+e.msg+"</li></ul>");break;case 1:$("#invitecodeStateTip").addClass("succ").removeClass("error").html("<ul><li>"+e.msg+"</li></ul>");break;default:$("#invitecodeStateTip").addClass("error").removeClass("succ").html("<ul><li>"+e.msg+"</li></ul>")}S,$("#invitecodeStateTip").show()}})},update:function(e,a){var t={};switch(e){case"profiles":t=this._validateProfiles();break;case"sync/b3":t=this._validateSyncB3();break;case"password":t=this._validatePassword();break;case"privacy":t={userArticleStatus:$("#userArticleStatus").prop("checked"),userCommentStatus:$("#userCommentStatus").prop("checked"),userFollowingUserStatus:$("#userFollowingUserStatus").prop("checked"),userFollowingTagStatus:$("#userFollowingTagStatus").prop("checked"),userFollowingArticleStatus:$("#userFollowingArticleStatus").prop("checked"),userWatchingArticleStatus:$("#userWatchingArticleStatus").prop("checked"),userFollowerStatus:$("#userFollowerStatus").prop("checked"),userPointStatus:$("#userPointStatus").prop("checked"),userOnlineStatus:$("#userOnlineStatus").prop("checked"),userJoinPointRank:$("#joinPointRank").prop("checked"),userJoinUsedPointRank:$("#joinUsedPointRank").prop("checked"),userUAStatus:$("#userUAStatus").prop("checked"),userTimelineStatus:$("#userTimelineStatus").prop("checked"),userForgeLinkStatus:$("#userForgeLinkStatus").prop("checked")};break;case"function":t={userListPageSize:$("#userListPageSize").val(),userCommentViewMode:$("#userCommentViewMode").val(),userAvatarViewMode:$("#userAvatarViewMode").val(),userNotifyStatus:$("#userNotifyStatus").prop("checked"),userSubMailStatus:$("#userSubMailStatus").prop("checked"),userKeyboardShortcutsStatus:$("#userKeyboardShortcutsStatus").prop("checked")};break;case"emotionList":t=this._validateEmotionList();break;case"i18n":t={userLanguage:$("#userLanguage").val(),userTimezone:$("#userTimezone").val()};break;default:console.log("update settings has no type")}if(!t)return!1;$.ajax({url:Label.servePath+"/settings/"+e,type:"POST",headers:{csrfToken:a},cache:!1,data:JSON.stringify(t),beforeSend:function(){$("#"+e.replace(/\//g,"")+"Tip").removeClass("succ").removeClass("error").html("")},error:function(e,a,t){alert(t)},success:function(a,r){if(a.sc){if($("#"+e.replace(/\//g,"")+"Tip").addClass("succ").removeClass("error").html("<ul><li>"+Label.updateSuccLabel+"</li></ul>").show(),"profiles"===e)return $("#userNicknameDom").text(t.userNickname),$("#userTagsDom").text(t.userTags),$("#userURLDom").text(t.userURL).attr("href",t.userURL),void $("#userIntroDom").text(t.userIntro)}else $("#"+e.replace(/\//g,"")+"Tip").addClass("error").removeClass("succ").html("<ul><li>"+a.msg+"</li></ul>");$("#"+e.replace(/\//g,"")+"Tip").show(),setTimeout(function(){$("#"+e.replace(/\//g,"")+"Tip").hide(),"i18n"===e&&window.location.reload()},5e3)}})},updateAvatar:function(e){var a={userAvatarURL:$("#avatarURL").data("imageurl")};$.ajax({url:Label.servePath+"/settings/avatar",type:"POST",headers:{csrfToken:e},cache:!1,data:JSON.stringify(a),beforeSend:function(){},error:function(e,a,t){alert(t)},success:function(e,t){e.sc&&$("#avatarURLDom, .user-nav .avatar-small").attr("style","background-image:url("+a.userAvatarURL+")")}})},_validateProfiles:function(){return!!Validate.goValidate({target:$("#profilesTip"),data:[{target:$("#userNickname"),type:"string",min:0,max:20,msg:Label.invalidUserNicknameLabel},{target:$("#userTags"),type:"string",min:0,max:255,msg:Label.tagsErrorLabel},{target:$("#userURL"),type:"string",min:0,max:255,msg:Label.invalidUserURLLabel},{target:$("#userIntro"),type:"string",min:0,max:255,msg:Label.invalidUserIntroLabel}]})&&{userNickname:$("#userNickname").val().replace(/(^\s*)|(\s*$)/g,""),userTags:$("#userTags").val().replace(/(^\s*)|(\s*$)/g,""),userURL:$("#userURL").val().replace(/(^\s*)|(\s*$)/g,""),userIntro:$("#userIntro").val().replace(/(^\s*)|(\s*$)/g,"")}},_validateSyncB3:function(){return!!Validate.goValidate({target:$("#syncb3Tip"),data:[{target:$("#soloKey"),type:"string",max:20,msg:Label.invalidUserB3KeyLabel},{target:$("#soloPostURL"),type:"url",msg:Label.invalidUserB3ClientURLLabel},{target:$("#soloUpdateURL"),type:"url",msg:Label.invalidUserB3ClientURLLabel},{target:$("#soloCmtURL"),type:"url",msg:Label.invalidUserB3ClientURLLabel}]})&&{userB3Key:$("#soloKey").val().replace(/(^\s*)|(\s*$)/g,""),userB3ClientAddArticleURL:$("#soloPostURL").val().replace(/(^\s*)|(\s*$)/g,""),userB3ClientUpdateArticleURL:$("#soloUpdateURL").val().replace(/(^\s*)|(\s*$)/g,""),userB3ClientAddCommentURL:$("#soloCmtURL").val().replace(/(^\s*)|(\s*$)/g,""),syncWithSymphonyClient:$("#syncWithSymphonyClient").prop("checked")}},_validatePassword:function(){var e=$("#pwdOld").val(),a=$("#pwdNew").val();if(Validate.goValidate({target:$("#passwordTip"),data:[{target:$("#pwdOld"),type:"password",msg:Label.invalidPasswordLabel},{target:$("#pwdNew"),type:"password",msg:Label.invalidPasswordLabel},{target:$("#pwdRepeat"),type:"password",oranginal:$("#pwdNew"),msg:Label.confirmPwdErrorLabel}]})){if(a!==$("#pwdRepeat").val())return!1;var t={};return t.userPassword=calcMD5(e),t.userNewPassword=calcMD5(a),t}return!1},_validateEmotionList:function(){return{emotions:$("#emotionList").val()}},makeAllNotificationsRead:function(){$.ajax({url:Label.servePath+"/notification/all-read",type:"GET",cache:!1,success:function(e,a){e.sc&&window.location.reload()}})},initFunction:function(){$("#emojiGrid img").click(function(){var e=$(this).attr("alt");-1===$("#emotionList").val().indexOf(e)&&(""!==$("#emotionList").val()?$("#emotionList").val($("#emotionList").val()+","+e):$("#emotionList").val(e))})},initHome:function(){"commentsAnonymous"!==Label.type&&"comments"!==Label.type||Settings.initHljs(),"linkForge"===Label.type&&Util.linkForge(),"mobile"!==$.ua.device.type&&Settings.homeScroll(),$.pjax({selector:"a",container:"#home-pjax-container",show:"",cache:!1,storage:!0,titleSuffix:"",filter:function(e){return 0>e.indexOf(Label.servePath+"/member/"+Label.userName)},callback:function(e){switch(e.type){case"success":case"cache":switch($(".home-menu a").removeClass("current"),location.pathname){case"/member/"+Label.userName:case"/member/"+Label.userName+"/comments":Settings.initHljs();case"/member/"+Label.userName+"/articles/anonymous":case"/member/"+Label.userName+"/comments/anonymous":Settings.initHljs(),$(".home-menu a:eq(0)").addClass("current");break;case"/member/"+Label.userName+"/watching/articles":case"/member/"+Label.userName+"/following/users":case"/member/"+Label.userName+"/following/tags":case"/member/"+Label.userName+"/following/articles":case"/member/"+Label.userName+"/followers":$(".home-menu a:eq(1)").addClass("current");break;case"/member/"+Label.userName+"/points":$(".home-menu a:eq(2)").addClass("current");break;case"/member/"+Label.userName+"/forge/link":$(".home-menu a:eq(3)").addClass("current"),Util.linkForge()}}$(".nav-tabs").html($(".home-menu").html())}}),NProgress.configure({showSpinner:!1}),$("#home-pjax-container").bind("pjax.start",function(){NProgress.start()}),$("#home-pjax-container").bind("pjax.end",function(){NProgress.done()})}};